<style>
    #pip-container {
        position: absolute;
        background: transparent;
        left: 500px;
        width: 99px;
        height: 100px;
        display: grid;
        grid-template-columns: 33px 33px 33px;
        grid-gap: 0;
    }

    .pips {
        height: 100%;
        width: 100%;
        align-items: stretch;
    }

    .pips span {
        position: relative;
        display: flex;
        align-items: center;
        width: 33%;
        height: 30px;
        box-sizing: border-box;
        background-color: black;
        border: 1px solid white;
        margin: 10px;
        border-radius: 20px;
    }

    .pips span.active {
        background-color: #42D6CA;
        border-color: #white;
    }

    .pips span.half-active {
        background: linear-gradient(to bottom, #000000 0%,#000000 46%,#42d6ca 50%,#42d6ca 100%);
    }

    #pip-container .systems {
        background-color: rgba(0, 0, 255, 0.2);
    }

    #pip-container .engines {
        background-color: rgba(0, 255, 0, 0.2);
    }

    #pip-container .weapons {
       background-color: rgba(255, 0, 0, 0.2);
    }
</style>

<div class="row">
    <span id="time">Game Time: <i></i></span>

    <div id="pip-container">
        <div class="pips systems">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="pips engines">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="pips weapons">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <table class="table" id="pips">
        <thead>
            <caption>Pips</caption>
            <tr>
                <th>System</th>
                <th>Engine</th>
                <th>Weapons</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </tbody>
    </table>
    <ul id="status-list">

    </ul>

<script type="text/javascript" src="node_modules/nes/dist/client.js"></script>
<script>
    var client = new nes.Client('ws://localhost:12342');

    const start = async () => {

        const timeEl = document.getElementById('time');
        const pipsTable = document.getElementById('pips');
        const statusList = document.getElementById('status-list');
        const pipContainer = document.getElementById('pip-container');

        const handler = (update, flags) => {
            console.log(update);

            const time = new Date(update.timestamp).toISOString().slice(-13, -5);
            timeEl.children[0].innerText = time;

            const sysElms = Array.from(document.querySelectorAll('.systems span')).reverse();
            const engElms = Array.from(document.querySelectorAll('.engines span')).reverse();
            const wepElms = Array.from(document.querySelectorAll('.weapons span')).reverse();

            const maxSysPips = Math.ceil(update.pips.sys);
            const maxEngPips = Math.ceil(update.pips.eng);
            const maxWepPips = Math.ceil(update.pips.wep);
            console.log(`System: ${update.pips.sys}/${maxSysPips}, Engine: ${update.pips.eng}/${maxEngPips}, Weapon: ${update.pips.wep}/${maxWepPips}`);

            function valToElm(element, maxVal, index) {
                if (index < maxVal) {
                    if (index % 2 === 0) {
                        return element.classList.add('active');
                    }
                }
                if (index === maxVal) {
                    if (index % 2 === 0) {
                        return element.classList.add('active');
                    }
                    return element.classList.add('half-active');
                }
            }

            sysElms.forEach((element, index) => {
                // Remove any classes
                element.classList.remove('active');
                element.classList.remove('half-active');
                // Add active to the 
                valToElm(element, maxSysPips, index);
            });
            engElms.forEach((element, index) => {
                // Remove any classes
                element.classList.remove('active');
                element.classList.remove('half-active');
                valToElm(element, maxEngPips, index);
            });
            wepElms.forEach((element, index) => {
                // Remove any classes
                element.classList.remove('active');
                element.classList.remove('half-active');
                valToElm(element, maxWepPips, index);
            });

            pipsTable.querySelectorAll('td').forEach((el, index) => {
                if (index === 0) el.innerText = update.pips.sys;
                if (index === 1) el.innerText = update.pips.eng;
                if (index === 2) el.innerText = update.pips.wep;
            });

            statusList.innerHTML = Object.keys(update.status).map(key => {
                return `<li><strong>${key}:</stong>${update.status[key]}</li>`;
            }).join('');
        };

        await client.connect();
        client.subscribe('/stream/status', handler);
    };

    start();
</script>
